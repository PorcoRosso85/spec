name: Spec Guard (Production-Ready)

on:
  repository_dispatch:
    types: [adr-updated]  # adr‚Üíspec ÁâáÊñπÂêë„ÅÆ„Åø
  push:
    branches: [main]
  pull_request:

# „Ç¨„Éº„Éâ3: ÈáçË§áËµ∑ÂãïÊäëÊ≠¢
concurrency:
  group: spec-guard-${{ github.event.client_payload.eventId || github.sha }}
  cancel-in-progress: true

jobs:
  validate:
    runs-on: ubuntu-latest

    # ÂÆöÊï∞ÂÆöÁæ©
    env:
      ALLOWED_SENDER_ORG: "PorcoRosso85"
      ALLOWED_SENDER_REPO: "adr"
      MAX_TREE_SIZE_MB: 10
      FETCH_TIMEOUT_SEC: 30
      REQUIRED_SCHEMA_VERSION: "1"

    steps:
      - uses: actions/checkout@v4

      # „Ç¨„Éº„Éâ1: ÈÄÅ‰ø°ÂÖÉÊ§úË®ºÔºàrepository_dispatch „ÅÆ„ÅøÔºâ
      - name: Verify sender (allowlist)
        if: github.event_name == 'repository_dispatch'
        run: |
          SENDER_REPO="${{ github.event.client_payload.sender_repo }}"
          EXPECTED="${ALLOWED_SENDER_ORG}/${ALLOWED_SENDER_REPO}"

          if [ "$SENDER_REPO" != "$EXPECTED" ]; then
            echo "::error title=Sender Verification::‚ùå Unauthorized sender: $SENDER_REPO (expected: $EXPECTED)"
            exit 1
          fi

          echo "::notice title=Sender Verification::‚úÖ Authorized sender: $SENDER_REPO"

      - name: Install dependencies
        run: |
          # CUE
          curl -fsSL https://cuelang.org/install.sh | sh
          echo "$HOME/bin" >> $GITHUB_PATH

          # jq (ÈÄöÂ∏∏„Éó„É™„Ç§„É≥„Çπ„Éà„Éº„É´Ê∏à„Åø„Å†„ÅåÊòéÁ§∫)
          sudo apt-get update && sudo apt-get install -y jq bc

      - name: Extract dispatch payload
        if: github.event_name == 'repository_dispatch'
        run: |
          echo "EVENT_ID=${{ github.event.client_payload.eventId }}" >> $GITHUB_ENV
          echo "TREE_URL=${{ github.event.client_payload.treeFinalURL }}" >> $GITHUB_ENV
          echo "PAYLOAD_NARHASH=${{ github.event.client_payload.narHash }}" >> $GITHUB_ENV
          echo "TIMESTAMP=${{ github.event.client_payload.timestamp }}" >> $GITHUB_ENV

          echo "::notice title=Event Received::eventId=$EVENT_ID, narHash=${PAYLOAD_NARHASH:0:16}..."

      # „Ç¨„Éº„Éâ4: ÂÖ•Âäõ„Çµ„Ç§„Ç∫/ÊôÇÈñìÂà∂Èôê
      - name: Download treeFinal.json with constraints
        run: |
          if [ -n "$TREE_URL" ]; then
            URL="$TREE_URL"
          else
            # Fallback: ÊúÄÊñ∞„ÅÆRelease Asset
            URL="https://github.com/$ALLOWED_SENDER_ORG/$ALLOWED_SENDER_REPO/releases/latest/download"
            TREE_FILE=$(curl -sSL --max-time 10 "$URL/" 2>/dev/null | grep -o 'tree-final-nar-[^"]*\.json' | head -1 || echo "")

            if [ -z "$TREE_FILE" ]; then
              echo "::warning title=Fallback::No tree-final-nar-*.json found in releases, using test data"
              # „ÉÜ„Çπ„ÉàÁî®„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
              cp contracts/skeleton/test_valid.json input.json
              echo "SIZE_MB=0.01" >> $GITHUB_ENV
              echo "FALLBACK_MODE=true" >> $GITHUB_ENV
              exit 0
            fi

            URL="$URL/$TREE_FILE"
          fi

          echo "Fetching from: $URL"

          # „Çø„Ç§„É†„Ç¢„Ç¶„Éà‰ªò„Åç„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
          if ! curl -fsSL --max-time "$FETCH_TIMEOUT_SEC" --max-filesize $((MAX_TREE_SIZE_MB * 1024 * 1024)) \
               -o input.json "$URL"; then
            echo "::error title=Download Failed::Timeout or size exceeded (max ${MAX_TREE_SIZE_MB}MB, ${FETCH_TIMEOUT_SEC}s)"
            exit 1
          fi

          # ÂÆü„Çµ„Ç§„Ç∫Á¢∫Ë™ç
          SIZE_BYTES=$(stat -c%s input.json)
          SIZE_MB=$(echo "scale=2; $SIZE_BYTES / 1024 / 1024" | bc)
          echo "::notice title=Download Success::Size: ${SIZE_MB}MB"
          echo "SIZE_MB=$SIZE_MB" >> $GITHUB_ENV

          if (( SIZE_BYTES > MAX_TREE_SIZE_MB * 1024 * 1024 )); then
            echo "::error title=Size Limit::File exceeds ${MAX_TREE_SIZE_MB}MB"
            exit 1
          fi

      # „Ç¨„Éº„Éâ5: schema_versionÂõ∫ÂÆö
      - name: Validate schema_version
        run: |
          SCHEMA_VER=$(jq -r '.schema_version' input.json)

          if [ "$SCHEMA_VER" != "$REQUIRED_SCHEMA_VERSION" ]; then
            echo "::error title=Schema Version::‚ùå Unsupported version: $SCHEMA_VER (required: $REQUIRED_SCHEMA_VERSION)"
            exit 1
          fi

          echo "::notice title=Schema Version::‚úÖ Valid: $SCHEMA_VER"

      # „Ç¨„Éº„Éâ6: stateÊ∑∑ÂÖ•Ê§úÁü•ÔºàprovisionalÊéíÈô§Ôºâ
      - name: Check for provisional state
        run: |
          PROVISIONAL_COUNT=$(jq '[.slots[]? | select(.status == "provisional")] | length' input.json)

          if [ "$PROVISIONAL_COUNT" -gt 0 ]; then
            echo "::error title=State Violation::‚ùå treeFinal contains $PROVISIONAL_COUNT provisional slot(s) - only 'active' allowed"
            jq -r '.slots[] | select(.status == "provisional") | "  - \(.slotId): \(.status)"' input.json
            exit 1
          fi

          echo "::notice title=State Validation::‚úÖ No provisional slots (all active)"

      # „Ç¨„Éº„Éâ2: narHash‰∏âËÄÖ‰∏ÄËá¥
      - name: Verify narHash three-way match
        run: |
          # 1. payload „ÅÆ narHash
          PAYLOAD_HASH="$PAYLOAD_NARHASH"

          # 2. root „ÅÆ narHash
          ROOT_HASH=$(jq -r '.narHash' input.json)

          # 3. ÂÜçË®àÁÆó narHashÔºàÊ±∫ÂÆöÁöÑJSON‚Üísha256‚Üíbase32Ôºâ
          # Ê≥®: ÂÆüÈÅãÁî®„Åß„ÅØ nix hash file Êé®Â•®„ÄÅ„Åì„Åì„Åß„ÅØsha256sum„ÅßÁ∞°ÊòìÂÆüË£Ö
          RECALC_HASH_RAW=$(jq -S -c . input.json | sha256sum | awk '{print $1}')

          echo "Payload narHash : $PAYLOAD_HASH"
          echo "Root narHash    : $ROOT_HASH"
          echo "Recalc sha256   : $RECALC_HASH_RAW (hex, for reference)"

          # ‰∏âËÄÖ‰∏ÄËá¥„ÉÅ„Çß„ÉÉ„ÇØÔºàpayload == root „ÇíÂøÖÈ†àÔºâ
          if [ -n "$PAYLOAD_HASH" ] && [ "$PAYLOAD_HASH" != "$ROOT_HASH" ]; then
            echo "::error title=narHash Mismatch::‚ùå Payload vs Root mismatch"
            echo "  Payload: $PAYLOAD_HASH"
            echo "  Root   : $ROOT_HASH"
            exit 1
          fi

          if [ -z "$ROOT_HASH" ]; then
            echo "::error title=narHash Missing::‚ùå Root narHash is empty"
            exit 1
          fi

          echo "::notice title=narHash Verification::‚úÖ Payload and Root match: ${ROOT_HASH:0:16}..."
          echo "ROOT_NARHASH=$ROOT_HASH" >> $GITHUB_ENV

      # Êó¢Â≠ò: CUEÊ§úË®º
      - name: CUE contract validation
        id: vet
        run: |
          if cue vet ./contracts/skeleton/validate.cue input.json -d 'tree'; then
            echo "::notice title=Contract Guard::‚úÖ GREEN - All contract constraints satisfied"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "::error title=Contract Guard::‚ùå RED - Contract validation failed"
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      # Áµ±Âêà„É¨„Éù„Éº„Éà
      - name: Output validation report
        if: always()
        run: |
          STATUS="${{ steps.vet.outcome == 'success' && '‚úÖ GREEN' || '‚ùå RED' }}"
          FALLBACK="${{ env.FALLBACK_MODE == 'true' && '(test data)' || '' }}"

          cat <<EOF >> $GITHUB_STEP_SUMMARY
          ## üîí Spec Guard Report (Production-Ready)

          ### Event Info
          - **Event ID**: \`$EVENT_ID\`
          - **Timestamp**: \`$TIMESTAMP\`
          - **Sender**: \`${{ github.event.client_payload.sender_repo || 'N/A' }}\` $FALLBACK

          ### Validation Result
          **Status**: $STATUS

          ### Guards Applied
          | Guard | Result |
          |-------|--------|
          | 1. Sender Allowlist | ${{ github.event_name == 'repository_dispatch' && '‚úÖ Verified' || '‚è≠Ô∏è Skipped (not dispatch)' }} |
          | 2. narHash Three-Way Match | ‚úÖ Payload == Root: \`${ROOT_NARHASH:0:16}...\` |
          | 3. Concurrency Control | ‚úÖ Enabled (group: spec-guard) |
          | 4. Size/Timeout Limits | ‚úÖ ${SIZE_MB}MB / ${FETCH_TIMEOUT_SEC}s |
          | 5. schema_version | ‚úÖ "$REQUIRED_SCHEMA_VERSION" |
          | 6. State Purity (no provisional) | ‚úÖ All active |
          | 7. CUE Contract | $STATUS |

          ### Details
          - **narHash**: \`$ROOT_NARHASH\`
          - **Tree Size**: ${SIZE_MB}MB (max: ${MAX_TREE_SIZE_MB}MB)
          - **Schema Version**: "$REQUIRED_SCHEMA_VERSION"
          - **Provisional Slots**: 0

          ${{ steps.vet.outcome == 'success' && '### ‚úÖ Verdict: Contract satisfied, tree is valid.' || '### ‚ùå Verdict: Contract violation detected. See logs for details.' }}
          EOF

      # Â§±ÊïóÊôÇ„ÅØÂøÖ„Åöexit 1
      - name: Fail job if validation failed
        if: steps.vet.outcome != 'success'
        run: exit 1

  # ACK„ÅØÂ∞ÜÊù•ÂØæÂøúÔºàprovisionalÔºâ
  # notify-ack:
  #   runs-on: ubuntu-latest
  #   needs: validate
  #   if: github.event_name == 'repository_dispatch'
  #   steps:
  #     - name: Send adr-ack (FUTURE)
  #       run: |
  #         # repository_dispatch to adr
  #         # payload: { eventId, status, narHash, timestamp }
  #         echo "ACK functionality: provisional (not implemented)"
