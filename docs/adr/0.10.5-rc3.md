# ADR 0.10.5-rc3 — contracts-index / CUEファーストの固定化

* **Status**: RC3（採用候補）
* **Decision Date**: 2025-10-21
* **Owner**: Platform/Architecture
* **Related**: ADR 0.10.4（gated/quarantine）, ADR 0.10.5-rc1/rc2（index導入初版）

---

## 0. 要約（端的）

* **CUEが唯一の真実源（MUST）**：各 `features/**/manifest.cue`。
* **flakeは"用意係"（MUST）**：`gate gen-index` が `manifest.cue` 群から **`capsules/index.cue`** を自動生成。
* **単一import（MUST）**：契約参照は **常に `import "capsules/index"`**。直 import 禁止（lint強制）。
* **der最小（MUST）**：依存URI列挙だけで静的OK/NG判定。
* **dee整合（MUST）**：公開 `schema.{req,res}` が index と一致（= または包含）。
* **最小辞書（MUST）**：index は `schema.{req,res}`（クローズ）と `caps` と薄い `meta` のみ。
* **SemVer省略（MUST）**：互換レンジ検証なし。再現性は `flake.lock`。
* **rpc/proto省略（MUST）**：必要時に薄い識別子のみ追加。
* **決定性（MUST）**：安定ソート＋`cue fmt`、`genVersion`/`genHash` を埋め込み、同 lock でバイト等価。

---

## 1. 背景

* 0.10.4 で CI ゲートと最小スモークを確立。
* 0.10.5 では **URI→契約索引（index）方式** を導入し、flake 経由で index 自動生成、der/dee は同一 index を参照して静的検証する。

---

## 2. 決定（RFC2119）

* **CUEファースト（MUST）**：真実源は `features/**/manifest.cue`。
* **index自動生成（MUST）**：`gate gen-index` → `capsules/index.cue`（**手編集・コミット禁止**）。
* **単一import（MUST）**：`import "capsules/index"` のみ。`import "features/**"` は Fail。
* **der最小記述（MUST）**：`Uses: ["uri"]` だけ列挙。型は index 参照で決まる。
* **dee整合（MUST）**：`schema.req/res` が index と一致（= または包含）。
* **最小辞書（MUST）**：`schema.{req,res}` クローズ＋`caps`（列挙型）＋薄い `meta`。
* **SemVer省略（MUST）**：当面なし（`flake.lock` pin のみ）。
* **rpc/proto省略（MUST）**：当面なし。
* **決定性（MUST）**：安定ソート＋`cue fmt`＋`meta.genVersion`/`meta.genHash`。

---

## 3. スコープ / 非対象

* **スコープ**：index生成、静的検証（未知URI/型/能力）、DAG/存在、CIゲート、運用ガード。
* **非対象**：実行時設定（URL/timeout/認証）、SLO/到達性、SemVer/digest 厳密運用（将来）。

---

## 4. 最小辞書の仕様（`capsules/index.cue`）

* **粒度**：**1 URI = 1エントリ**（小文字+`.`）。
* **命名規約（MUST）**：`^[a-z][a-z0-9]*(\.[a-z0-9]+)*$`、長さ ≤ 64、エイリアス禁止、予約語：`schema`,`caps`,`meta`。
* **クローズ（MUST）**：未知フィールド禁止（`_: _|_`）。
* **入れる**：

  * `schema.req`：der→dee 入力型（必須/任意/値域まで）。
  * `schema.res`：dee→der 出力型。
  * `caps: [...string]`：能力（**列挙型**に一致）。
  * `meta?`：`{ gitRev, status, sunsetAt?, genVersion, genHash }`（薄いライフサイクル）。
* **入れない**：URL/timeout/認証/DB名/バケット名/外部URL/巨大OpenAPI・Proto本文 等。

**例（最小）**

```cue
package capsules_index

Caps: {
  "user.read": {
    schema: {
      req: { id: string & =~"^usr_[0-9a-z]{8}$" }
      res: { ok: bool, user?: { name: string } }
      _: _|_
    }
    caps: ["read"]
    meta?: { gitRev: string, status: *"active"|"deprecated"|"sunset", sunsetAt?: string, genVersion: string, genHash: string }
    _: _|_
  }
}
```

---

## 5. der / dee の最小テンプレ

**der（依存）**

```cue
package svc
import "capsules/index"

Uses: ["user.read"]        // 依存URIだけ列挙

DependsOn: {
  for u in Uses {
    "\(u)": {
      uri: u
      api: {
        requires:    capsules_index.Caps[u].schema.req
        requireCaps: *[] // 省略可
      }
    }
  }
}
```

**dee（提供）**

```cue
package provider
import "capsules/index"

provides: {
  "user.read": {
    schema: { req: {...}, res: {...} }
    caps: ["read"]
    _reqOK: schema.req == capsules_index.Caps["user.read"].schema.req
    _resOK: schema.res == capsules_index.Caps["user.read"].schema.res
  }
}
```

---

## 6. Nix/flake 連携（monorepo 内同居）

* **flow**：`manifest.cue` →（`gate gen-index`）→ `capsules/index.cue` → CUE検証。
* contracts-index flake は `flakes/contracts-index/` に置き、ルート flake から `inputs.contracts-index.url = "path:./flakes/contracts-index"` で参照。

**ルート `flake.nix`（骨子）**

```nix
{
  inputs.nixpkgs.url = "nixpkgs/nixos-24.05";
  inputs.contracts-index.url = "path:./flakes/contracts-index";  # 同居
  outputs = { self, nixpkgs, contracts-index, ... }:
  let
    pkgs = import nixpkgs { system = "x86_64-linux"; };
    CAPS = contracts-index.packages.${pkgs.system}.contracts-index;
  in {
    apps.${pkgs.system}.gate = {
      type = "app";
      program = pkgs.writeShellScript "gate" ''
        set -e
        OUT=$(${pkgs.nix}/bin/nix build --no-link ${toString CAPS} --print-out-paths)
        export CUE_PATH="$OUT"          # capsules/index.cue を見せる
        exec ${pkgs.go}/bin/gate "$@"   # gate lint/plan/smoke 等
      '';
    };
  };
}
```

**`flakes/contracts-index/flake.nix`（骨子）**

```nix
{
  description = "contracts index flake";
  inputs.nixpkgs.url = "nixpkgs/nixos-24.05";
  inputs.src.url = "path:../..";     # monorepo ルート（manifest群）
  outputs = { self, nixpkgs, src, ... }:
  let pkgs = import nixpkgs { system = "x86_64-linux"; }; in {
    packages.${pkgs.system}.contracts-index = pkgs.stdenv.mkDerivation {
      name = "contracts-index";
      src = src;
      buildInputs = [ pkgs.go ];
      buildPhase = ''gate gen-index --src $src --out $out'';  # 決定的生成
      installPhase = "true";
    };
  };
}
```

---

## 7. CI ゲート（最小UX / エラーカテゴリ）

### 最小UX（**必ず守る**）

* `nix build .#contracts-index`（index 生成）
* `nix run .#gate -- lint --all`（従来）
* `nix run .#gate -- lint contracts`（**未知URI/型不一致/能力不足/直import検出 → Fail**）
* `nix run .#gate -- plan --changed-only`（存在/DAG）
* `nix run .#gate -- smoke`（代表1本）

**DoD**：上記が **全て0終了**。index 出力は**決定的**（同 lock でバイト等価）。

### エラーカテゴリ（lint contracts）

* **L100** 未知URI
* **L101** 型不一致
* **L102** 能力不足（未知語含む）
* **L103** 直 import 検出（`features/**`）
* **L104** スキーマ非クローズ

### しきい値（Fail基準）

* `gen-index ≤ 10s / repo`、`lint contracts ≤ 5s / PR`、`capsules/index.cue ≤ 256KB` を超過で Fail → 改善タスク。

### 成果物

* `ci/reports/index.diff`（index の追加/変更/削除要約）
* `ci/reports/contracts.jsonl`（Lコード/URI/原因/位置）

---

## 8. 運用ガード

* **index 非コミット**：`.gitignore` に `capsules/index.cue` を追加。手編集禁止を lint で強制。
* **直 import 禁止**：pre-commit & `gate lint contracts` で Fail。
* **語彙の型付け**：`policy/cue/schemas/caps.cue` に列挙を集約、未知語は L102。
* **DAG/存在チェック**：Uses に対し **提供（dee）が最低1件** 必須。孤児は Fail。
* **生成ゆらぎ対策**：`env -i` で実行、時刻/乱数未使用、安定ソート＋`cue fmt`、`genVersion/genHash` 埋め込み。

---

## 9. 反パターン（禁止）

* index に実行時メタ（URL/timeout/認証/SLO 等）を入れる。
* 巨大 OpenAPI/Proto/JSON Schema 本文を直埋め。
* 複数の真実源（CUE と別仕様を併存主化）。
* `...`/`_` で開放し比較不能にする。

---

## 10. 互換・廃止（当面）

* SemVer/レンジ検査は未導入。必要時：`meta.major/status/sunsetAt` を index に追加し、

  * 破壊変更＝**新URI**（例：`user.read.v2`）
  * `deprecated/sunsetAt` による段階移行（期限前 WARN → 期限後 ERROR）を CI で強制。

---

## 11. 残タスク

* **T-101**：`gate gen-index` 実装（決定性、孤児/重複URI検出、`cue fmt`、`genVersion/genHash`）。
* **T-102**：`gate lint contracts` 実装（L100–L104）。
* **T-103**：OpenAPI→CUE 正規化ルール文書化（`oneOf/nullable/additionalProperties`）。
* **T-104**：pre-commit/CODEOWNERS 整備（契約変更の必須レビュー、直 import 禁止）。
* **T-105**：changed-only 精度向上（依存閉包計算の高速化）。
* **T-106**：index しきい値監視（行数/サイズ/生成時間）。
* **T-107**：ゴールデンテスト（代表 manifest → index のスナップショット）。
* **T-108**：互換管理フック予約（`meta.major/status/sunsetAt` と CI 対応）。
* **T-109**：index シャーディング検討（`CapsA_M` / `CapsN_Z`）。
* **T-110**：抽出器拡張（OpenAPI/JSON/AsyncAPI/Avro/GraphQL → 最小投影）。

---

## 12. マイグレーション

1. 各 `manifest.cue` を**クローズ化**（req/res/caps 明示）。
2. `.gitignore` に `capsules/index.cue` を追加し、既存コミット物があれば削除。
3. `gate gen-index` を導入（決定性メタ埋め込み）。
4. der を**最小テンプレ**に統一（`import "capsules/index"`＋Uses 列挙）。
5. CI に `lint contracts` を追加して gated に。

---

## 13. バックアウト

* 一時的に `lint contracts` を WARNING 化（CI 非ブロック）。
* index 生成失敗時は **規約パス直 import** を暫定許可（"非常口"ラベル必須。7日以内に復旧）。

---

## 14. 完全ツリー（**MUST と CI最小UX をコメントで同梱**）

```
repo/
├─ flake.nix                               — ルートflake（gate実行・検証エントリ）
│  # MUST: 契約参照は import "capsules/index" のみ（直 import 禁止）
│  # MUST: 同一 flake.lock で index 出力はバイト等価（決定性）
│  # CI最小UX:
│  #   1) nix build .#contracts-index
│  #   2) nix run .#gate -- lint --all
│  #   3) nix run .#gate -- lint contracts   # L100–L104 を Fail
│  #   4) nix run .#gate -- plan --changed-only
│  #   5) nix run .#gate -- smoke            # 代表1本
│  # DoD: 上記すべて 0 終了 + index バイト等価
├─ flake.lock                              — 版固定（再現性の要）
├─ .gitignore                              — ★ `capsules/index.cue` を必ず除外（手編集/コミット禁止）
├─ flakes/
│  └─ contracts-index/                     — ★ index専用flake（monorepo内同居）
│     ├─ flake.nix                         — manifest 群→ index を決定的生成
│     └─ README.md                         — 生成規約/決定性/しきい値の説明
├─ policy/
│  ├─ cue/
│  │  ├─ policy.cue                        — 既存ポリシー集約
│  │  ├─ contracts.cue                     — contracts検証ハブ（der/dee 共通）
│  │  ├─ strict.cue                        — 直 import 禁止/クローズ化等のガード
│  │  └─ schemas/
│  │     └─ caps.cue                       — ★ caps 語彙の列挙型（未知語は L102）
│  └─ tools/
│     └─ gate/
│        ├─ cmd/gate/main.go               — CLI入口
│        ├─ internal/cmds/gate_gen_index.go      — ★ manifest→index 生成（安定ソート/`cue fmt`）
│        ├─ internal/cmds/gate_lint_contracts.go — ★ L100–L104: 未知URI/型/能力/直import/非クローズ
│        ├─ internal/cmds/gate_plan.go           — 影響/DAG/存在（Uses→提供1件必須）
│        ├─ internal/cmds/gate_smoke.go          — 最小スモーク（代表1本）
│        ├─ internal/cmds/lint_*.go              — 既存lint群
│        └─ repo_lint                            — 互換シム（0.10.5系で最終撤去予定）
├─ platform/                                — 共通基盤（0.10.4踏襲）
├─ features/                                — dee（提供）: **UGC × PSEO の提供機能**
│  ├─ ugc/post/
│  │  ├─ manifest.cue                      — 提供URI: `ugc.post.create`, `ugc.post.read`, `ugc.post.list`
│  │  └─ README.md
│  ├─ ugc/moderation/
│  │  ├─ manifest.cue                      — 提供URI: `ugc.moderation.check`
│  │  └─ README.md
│  ├─ media/uploader/
│  │  ├─ manifest.cue                      — 提供URI: `media.image.upload`
│  │  └─ README.md
│  ├─ seo/pseo/
│  │  ├─ manifest.cue                      — 提供URI: `seo.pseo.generate`（プログラマティックページ用データ生成）
│  │  └─ README.md
│  ├─ seo/sitemap/
│  │  ├─ manifest.cue                      — 提供URI: `seo.sitemap.update`
│  │  └─ README.md
│  └─ seo/indexing/
│     ├─ manifest.cue                      — 提供URI: `seo.index.notify`（検索エンジン通知）
│     └─ README.md
├─ deployables/                             — der（実アプリ/バッチ）: **UGC × PSEO をデプロイ**
│  ├─ web/pseo-site/
│  │  ├─ manifest.cue                      — Uses: ["seo.pseo.generate", "ugc.post.read"]
│  │  └─ pipeline.cue
│  ├─ api/public/
│  │  ├─ manifest.cue                      — Uses: ["ugc.post.create", "ugc.post.read", "media.image.upload"]
│  │  └─ pipeline.cue
│  ├─ worker/moderation/
│  │  ├─ manifest.cue                      — Uses: ["ugc.moderation.check", "ugc.post.create"]
│  │  └─ pipeline.cue
│  ├─ batch/sitemap/
│  │  ├─ manifest.cue                      — Uses: ["seo.sitemap.update", "seo.index.notify"]
│  │  └─ pipeline.cue
│  └─ cron/generate-pseo/
│     ├─ manifest.cue                      — Uses: ["seo.pseo.generate"]（定期生成ジョブ）
│     └─ pipeline.cue
├─ env/                                     — 生成環境テンプレ（0.10.4踏襲）
│  └─ .gen/
│     ├─ dev.env
│     ├─ stg.env
│     └─ prod.env
├─ secrets/                                 — 機密（0.10.4踏襲）
│  ├─ .sops.yaml
│  ├─ values.sops.yaml
│  └─ age/README.md
├─ capsules/                                — ★ 生成物（**コミット不要/禁止**）
│  └─ index.cue                             — URI→最小辞書（決定的生成；`genVersion/genHash` 埋め込み）
├─ ci/
│  ├─ artifacts/
│  │  ├─ index.json
│  │  └─ tests/**
│  └─ reports/
│     ├─ gate-p6.json                       — gatedスナップショット（0.10.4踏襲）
│     ├─ flakes.jsonl                        — フレーク記録（0.10.4踏襲）
│     ├─ contracts.jsonl                     — ★ lint結果（L100–L104）
│     └─ index.diff                          — ★ index要約差分（追加/変更/削除）
├─ .github/workflows/
│  ├─ ci.yml                                — ★ 最小UX: build→lint→plan→smoke を直列
│  ├─ quarantine.yml
│  └─ nightly.yml
├─ docs/
│  ├─ adr/
│  │  ├─ 0.10.4.md                          — 既存：テスト方針
│  │  ├─ 0.10.5.md                          — 既存：index導入 初版（rc1）
│  │  ├─ 0.10.5-r2.md                       — 既存：rc2
│  │  ├─ 0.10.5-rc3.md                      — ★ 本ADR（rc3：この文書）
│  │  └─ 0.10.5-final.md                    — リリース時に確定版
│  └─ conventions/
│     ├─ NAMING.md                          — URI命名規約（正規表現/長さ）
│     ├─ CUE_SCHEMA.md                      — クローズ化/正規化ルール/optional・default指針
│     ├─ MARKDOWNLINT.md
│     ├─ STORAGE.md
│     ├─ NIX.md
│     └─ RELIABILITY.md                     — ゲート/指標/運用
└─ README.md
```

---

## 15. 受入基準（DoD）

* `gen-index` が**決定的**（同 `flake.lock` でバイト等価、`genVersion/genHash` 一致）。
* `lint contracts` が **L100–L104** を検出し 0/非0 を正しく返す。
* `capsules/index.cue` は **非コミット**（.gitignore 登録）。
* `caps` 語彙が列挙に収束、未知語は Fail。
* CI に `index.diff` と `contracts.jsonl` が残る。

---

## 16. 付録：運用チェックリスト（短）

* [ ] `gen-index` は決定的（安定ソート・fmt・`genVersion/genHash`）。
* [ ] `lint contracts` で未知URI/型/能力/直import/非クローズを Fail。
* [ ] URI は小文字+`.`、**1 URI=1エントリ**、長さ≤64。
* [ ] `schema.*` はクローズ。optional/default の扱い統一。
* [ ] index に実行時メタを入れない。
* [ ] しきい値：`gen-index≤10s`、`lint≤5s`、`index≤256KB`。超過時は改善タスク。
* [ ] CI に index 差分要約を残す（監査）。
