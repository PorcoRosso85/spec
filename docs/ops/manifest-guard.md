# manifest-guard.md

## 1. これは何か
- 本番インフラ / 課金 / 権限 / データ保持期間 など
  を決めるマニフェスト(=設定ファイル、CUE出力、OpenTofuのmodule入力/出力など)
  を安全に変えるための運用ルール。
- 目的は「うっかり事故で本番を止めない・課金爆増させない」こと。
- 設計の背景は docs/adr/ 側にある。ここは手順とチェックだけを書く。

## 2. 守備範囲
対象になるのはだいたい次のもの:
- `infra/provisioning/` 配下の module / environments / backend 設定
- そこから出る `tofu output` の値 (R2バケット名・CDN設定・computeサイズなど)
- `apps/*/manifest.cue` や `apps/*/pipeline.cue` が宣言するリソースの紐づけ
- 課金や公開可否などユーザ影響の大きいフラグ

これらは「壊すとサービス停止・データ消失・請求額ジャンプ」が起きる領域。

## 3. 仕組みの要点
1. 各サービスが使うインフラは flake/CUE から manifest を生成する。
2. サービスごとに「これだけを使ってよい」という allowlist(許可リスト)を持つ想定。
   - 許可されていないリソース/権限を勝手に足すと警告になる。
3. CIでは以下を行う想定:
   - 生成された manifest が allowlist の部分集合かチェックする(subsetチェック)。
   - 危険な変更パターン(例: `public=true`, `deleteAfterDays=0`, `replicas=0`)を
     forbidden_patterns として検出する。
4. このチェックは段階的に強くする:
   - P0: 変更があればPRに警告コメントを付けるだけ (記録目的)。
   - P1: main へ直接pushを弾き、PR経由を必須にする。
   - P2: 危険diffを含んだPRはCIでfailにしてマージ不可にする。
   (今は P0→P1 の途中段階という想定。)

まとめると:
- 人間が読むチェックリスト＋CIのallowlist検証＋禁止パターン検出で守る。

## 4. 変更前チェックリスト
PRを切る前に必ず自分で埋める。

1. どのファイルを触る？  
   例: `infra/provisioning/environments/prod/terraform.tfvars` など
2. そのファイルはどこで効く？  
   本番？staging？devだけ？課金計算？CDNの公開範囲？
3. そのキー/フィールドの意味は理解してる？  
   よく分からない行は rename / 削除しないでコメント化など軽い形にする。
4. 影響リスクは何？  
   - 課金が跳ねる？
   - セキュリティが緩む？
   - データ保持ポリシーが変わる？
5. 検証できる？  
   - ローカル or staging で `plan.sh` / `apply.sh` / `verify.sh` が回せる？
   - 回せるなら必ず回して差分を確認した？

この5つを書かずに main を変えるのはNG。

## 5. PRの作り方
1. 変更はピンポイントに分ける。関係ないリファクタを同じPRに混ぜない。
2. PRタイトルに `[manifest]` などわかりやすいprefixを付ける。
3. 上の「変更前チェックリスト」の回答メモをPR本文に貼る。
4. main に直接 push はしない。必ずPR経由。

## 6. マージ後にやること
1. 本番に反映されたか確認する。
2. ログ / メトリクス / 警報をざっと見る。
3. おかしかったら即座に revert PR を切る。言い訳より先に戻す。

## 7. 今後の自動化TODO
- CIが manifest の差分を見て危険パターンをコメントするbotを入れる。
- `infra/adapters/storage/s3/` のような禁止ディレクトリ復活を自動でブロックする。
- allowlist と実manifestのズレがあれば fail まで持っていく(P2化)。

## 8. 関連
- 運用フロー全体・IaCの実行手順: `./index.md`
- シークレット / .env の扱い: `./secrets.md`
- リポジトリ構成と依存ルール: `../structure/index.md`
- 背景・理由・議論の履歴: `../adr/`
